{% load static %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'CSS/style_form.css' %}">

    <title>Cadastro de Movimentação</title>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
      <img src="{% static 'IMG/logo_png_site.png' %}" alt="Descrição da Imagem" class="img-fluid" style="max-height: 40px;">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
              data-bs-target="#navbarSupportedContent" 
              aria-controls="navbarSupportedContent" 
              aria-expanded="false" 
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/form">Cadastro</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/home">Listagem</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/estoque">Estoque</a>
          </li>
        </ul>
        <form class="d-flex">

        </form>
      </div>
    </div>
  </nav>

  <div class="container mt-3">
    <header class="text-center">
        <div class="col-12 text-center mb-4">
          <h1 class="display-6">Cadastro de Movimentação </h1>
        </div>
    </header>
    <div class="col-12 col-sm-12 col-md-8 col-lg-8 col-xl-8 col-xxl-8 m-auto">
        <div id="inicial">
            <div id="feedback" class="mt-3"></div>
        <div class="card">
          <form action="{% if form.instance.pk %}/update/{{ form.instance.pk }}/{% else %}/create/{% endif %}" method="POST" >
              {% csrf_token %}
              <div class="form-group">
                  <label for="entrada_saida">Entrada/Saída:</label>
                  <select id="entrada_saida" name="entrada_saida" class="form-control">
                      <option value="Entrada" {% if form.entrada_saida.value == "Entrada" %}selected{% endif %}>Entrada</option>
                      <option value="Saida" {% if form.entrada_saida.value == "Saida" %}selected{% endif %}>Saída</option>
                  </select>
              </div>
              
              <div class="form-group">
                  <label for="data">Data:</label>
                  <input type="date" id="data" name="data" class="form-control" value="{{ form.data.value|default_if_none:'' }}" required>
              </div>
              
              <div class="form-group">
                  <label for="qtde">Quantidade:</label>
                  <input type="number" id="qtde" name="qtde" class="form-control" value="{{ form.qtde.value|default_if_none:'' }}" required>
              </div>

              <div class="form-group">
                <label for="formato">Formato:</label>
                <select id="formato" name="formato" class="form-control" onchange="atualizaTipo(); atualizaSubcategoria()"  >
                    <option value="">Selecione um tipo</option>
                    <option value="Acabamento" {% if form.formato.value == "Acabamento" %}selected{% endif %}>Acabamento</option>
                    <option value="Impressão" {% if form.formato.value == "Impressão" %}selected{% endif %}>Impressão</option>
                    <option value="Expedição" {% if form.formato.value == "Expedição" %}selected{% endif %}>Expedição</option>
                    <option value="Limpeza" {% if form.formato.value == "Limpeza" %}selected{% endif %}>Limpeza</option>
                    <option value="TintaTonner" {% if form.formato.value == "TintaTonner" %}selected{% endif %}>TintaTonner</option>
                    <option value="Escritório" {% if form.formato.value == "Escritório" %}selected{% endif %}>Escritório</option>
                    <option value="Mercado" {% if form.formato.value == "Mercado" %}selected{% endif %}>Mercado</option>
                </select>
            </div>

              <div class="form-group">
                  <label for="tipo">Unidades:</label>
                  <select id="tipo" name="tipo" class="form-control" onchange="toggleEspecificacoes(this.value)">
                      <option value="" {% if form.tipo.value == "" %}selected{% endif %}></option>
                      <option value="Cx" {% if form.tipo.value == "Cx" %}selected{% endif %}>Cx</option>
                      <option value="Unidades" {% if form.tipo.value == "Unidades" %}selected{% endif %}>Unidades</option>
                      <option value="Pacotes" {% if form.tipo.value == "Pacotes" %}selected{% endif %}>Pacotes</option>
                      <option value="Placas" {% if form.tipo.value == "Placas" %}selected{% endif %}>Placas</option>
                  </select>
              </div>

              <div class="form-group">
                  <label for="tipo_de_material">Subcategoria:</label>
                  <select id="tipo_de_material" name="tipo_de_material" class="form-control">
                      <option value="">Selecione uma subcategoria</option>
                  </select>
              </div>

              <div class="form-group">
                <input type="hidden" id="nome" name="nome" class="form-control" 
                value="{% if form.nome.value %}{{ form.nome.value }}{% else %}{{ nome_usuario }}{% endif %}">
                       </div>
              
              <div id="especificacoes" class="hidden">
                  <div class="form-group">
                      <label for="folha">Folha:</label>
                      <input type="text" id="folha" name="folha" class="form-control" value="{{ form.folha.value|default_if_none:'' }}">
                  </div>

                  <div class="form-group">
                      <label for="formato_da_folha">Formato:</label>
                      <select id="formato_da_folha" name="formato_da_folha" class="form-control" >
                          <option value="null" {% if form.formato_da_folha.value == "null" %}selected{% endif %}>Selecione um tamanho</option>
                          <option value="640x880" {% if form.formato_da_folha.value == "640x880" %}selected{% endif %}>640x880</option>
                          <option value="660x960" {% if form.formato_da_folha.value == "660x960" %}selected{% endif %}>660x960</option>
                      </select>
                  </div>
              </div>
              
              <input type="submit" class="btn btn-success" value="Salvar">
          </form>
        </div>
    </div>
        </div>
        
    <footer class="footer">
        <p>&copy; 2024 CDG Estoque. Todos os direitos reservados.</p>
    </footer>
  </div>

  {% if messages %}

  <!-- Modal -->
  <div class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true" id="alert">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">Atenção</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <span id="alert-message"></span>
        </div>
        <div class="modal-footer">
          <button onclick="loading-btn()" type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

<!-- Spinner de loading -->
<div id="loading-spinner" class="spinner-border text-primary" role="status" style="display: none;">
  <span class="visually-hidden">Carregando...</span>
</div>

  <script>
    // Quando a página carregar
    window.onload = function() {
      var myModal = new bootstrap.Modal(document.getElementById('alert'));
      var alertMessage = document.getElementById('alert-message'); // Corrigido aqui
      var form = document.querySelector('form');
      var loadingSpinner = document.getElementById('loading-spinner'); // Spinner de loading

      // Exibir mensagens após o envio
      {% for message in messages %}
          alertMessage.innerText = '{{ message }}'; // Corrigido aqui
          myModal.show();
      {% endfor %}

      // Função para mostrar o spinner enquanto o formulário é enviado
      form.onsubmit = function(event) {
          event.preventDefault(); // Previne o envio normal do formulário
          loadingSpinner.style.display = 'block'; // Mostra o spinner

          // Agora, envia o formulário via AJAX ou espera a resposta do back-end
          var formData = new FormData(form);

          fetch(form.action, {
              method: 'POST',
              body: formData,
              headers: {
                  'X-CSRFToken': '{{ csrf_token }}', // CSRF token para segurança
              },
          })
          .then(response => response.json())
          .then(data => {
              // Após o envio bem-sucedido
              loadingSpinner.style.display = 'none'; // Esconde o spinner
              alertMessage.innerText = data.message; // Mostra a mensagem de sucesso ou erro
              myModal.show(); // Exibe o modal
          })
          .catch(error => {
              // Caso ocorra algum erro
              loadingSpinner.style.display = 'none'; // Esconde o spinner
              alertMessage.innerText = 'Erro ao enviar dados. Tente novamente.';
              myModal.show();
          });
      };
  };
{% endif %}


    </script>

</body>
</html>
    <script src="{% static 'js/script_form.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js" integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy" crossorigin="anonymous"></script></body>
</html>


